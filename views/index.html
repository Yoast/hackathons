<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>

    <h1>Lunchbot program</h1>
    <p>Checks next week's lunch availability</p>

    <script>
        function sendSlackMessage(username) {

            let text = "Vul aub even de lunchlijst van volgende week in Jesser!";
            let xmlhttp = new XMLHttpRequest();

            let url = "https://slack.com/api/chat.postMessage?token=SECRET&channel=%40" + username + "&text=" + text + "%20&as_user=LunchBot&pretty=1";

            xmlhttp.onreadystatechange = function() {
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    let response = xmlhttp.responseText; //if you need to do something with the returned value
                }
            };

            xmlhttp.open("GET", url, true);
            xmlhttp.send();
        }

        function makeApiCall() {
            var params = {

                spreadsheetId: 'SECRET',

                range: 'Oktober!I46',

            };

            var request = gapi.client.sheets.spreadsheets.values.get(params);
            request.then(function(response) {

                handleSheetResult(response.result)

            }, function(reason) {
                console.error('error: ' + reason.result.error.message);
            });
        }

        function initClient() {
            var API_KEY = 'SECRET';

            var CLIENT_ID = 'SECRET';

            var SCOPE = 'https://www.googleapis.com/auth/spreadsheets.readonly';

            gapi.client.init({
                'apiKey': API_KEY,
                'clientId': CLIENT_ID,
                'scope': SCOPE,
                'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            }).then(function() {
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSignInStatus);
                updateSignInStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            });
        }

        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        function updateSignInStatus(isSignedIn) {
            if (isSignedIn) {
                makeApiCall();
            }
        }

        function handleSignInClick(event) {
            gapi.auth2.getAuthInstance().signIn();
        }

        function handleSignOutClick(event) {
            gapi.auth2.getAuthInstance().signOut();
        }

        function handleSheetResult(result) {

            if (result.values !== undefined) {

                document.body.innerHTML += "<h3> Je luncht mee, goedzo! </h3>";
                console.log("Je luncht mee")

            } else {
                document.body.innerHTML += "<h3>Je luncht niet mee, we sturen je een herinnering op Slack</h3>"
                sendSlackMessage("Jesser")
            }

        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()" onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>

</body>

</html>